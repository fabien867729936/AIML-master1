## 第八次课堂总结
  通过本节课的学习，我了解了卷积神经网络的卷积前向计算、反向传播的原理以及池化的前向计算与反向传播。
###  卷积神经网络
(1) 卷积网络的典型结构

一个典型的卷积神经网络的结构如下图所示：

![](1.jpg)

1.原始的输入是一张图片，可以是彩色的，也可以是灰度的或黑白的。这里假设是只有一个通道的图片，目的是识别0~9的手写体数字；

2.第一层卷积，我们使用了4个卷积核，得到了4张feature map；激活函数层没有单独画出来，这里我们紧接着卷积操作使用了Relu激活函数；

3.第二层是池化，使用了Max Pooling方式，把图片的高宽各缩小一倍，但仍然是4个feature map；

4.第三层卷积，我们使用了4x6个卷积核，其中4对应着输入通道，6对应着输出通道，从而得到了6张feature map，当然也使用了Relu激活函数；

5.第四层再次做一次池化，现在得到的图片尺寸只是原始尺寸的四分之一左右；
第五层把第四层的6个图片展平成一维，成为一个fully connected层；

6.第六层再接一个小一些的fully connected层；

7.最后接一个softmax函数，判别10个分类。

(2) 卷积核的作用

|序号|名称|说明| |---|---|---| |1|锐化|如果一个像素点比周围像素点亮，则此算子会令其更亮| |2|检测竖边|检测出了十字线中的竖线，由于是左侧和右侧分别检查一次，所以得到两条颜色不一样的竖线| |3|周边|把周边增强，把同色的区域变弱，形成大色块| |4|Sobel-Y|纵向亮度差分可以检测出横边，与横边检测不同的是，它可以使得两条横线具有相同的颜色，具有分割线的效果| |5|Identity|中心为1四周为0的过滤器，卷积后与原图相同| |6|横边检测|检测出了十字线中的横线，由于是上侧和下侧分别检查一次，所以得到两条颜色不一样的横线| |7|模糊|通过把周围的点做平均值计算而“杀富济贫”造成模糊效果| |8|Sobel-X|横向亮度差分可以检测出竖边，与竖边检测不同的是，它可以使得两条竖线具有相同的颜色，具有分割线的效果| |9|浮雕|形成大理石浮雕般的效果|

(3) 卷积后续的运算

(4) 卷积神经网络的学习
+ 旋转不变性
+ 尺度不变性
+ 平移不变性
### 卷积的前向计算
(1) 卷积的数学定义

连续定义:
$$h(x)=(f*g)(x) = \int_{-\infty}^{\infty} f(t)g(x-t)dt \tag{1}$$

卷积与傅里叶变换有着密切的关系。利用这点性质，即两函数的傅里叶变换的乘积等于它们卷积后的傅里叶变换，能使傅里叶分析中许多问题的处理得到简化。

离散定义:
$$h(x) = (f*g)(x) = \sum^{\infty}_{t=-\infty} f(t)g(x-t) \tag{2}$$

(2) 单入单出的二维卷积

二维卷积一般用于图像处理上。在二位图片上做卷积，如果把图像Image简写为$I$，把卷积核Kernal简写为$K$，则目标图片的第$(i,j)$个像素的卷积值为：
$$ h(i,j) = (I*K)(i,j)=\summ \sumn I(m,n)K(i-m,j-n) \tag{3} $$

(3) 单入多出的升维卷积

原始输入是一维的图片，但是我们可以用多个卷积核分别对其计算，从而得到多个特征输出。如下图所示：

一张4x4的图片，用两个卷积核并行地处理，输出为2个2x2的图片。在训练过程中，这两个卷积核会完成不同的特征学习。

(4) 多入单出的降维卷积

一张图片，通常是彩色的，具有红绿蓝三个通道。我们可以有两个选择来处理：

+ 变成灰度的，每个像素只剩下一个值，就可以用二维卷积
+ 对于三个通道，每个通道都使用一个卷积核，分别处理红绿蓝三种颜色的信息

(5) 多入多出的同维卷积

(6) 步长 stride

前面的例子中，每次计算后，卷积核会向右或者向下移动一个单元，即步长stride = 1。而在下面这个卷积操作中，卷积核每次向右或向下移动两个单元，即stride = 2。

在后续的步骤中，由于每次移动两格，所以最终得到一个2x2的图片。

(7) 填充 padding

如果原始图为4x4，用3x3的卷积核进行卷积后，目标图片变成了2x2。如果我们想保持目标图片和原始图片为同样大小，该怎么办呢？一般我们会向原始图片周围填充一圈0，然后再做卷积。

(8) 输出结果

综合以上所有情况，可以得到卷积后的输出图片的大小的公式：
$$ H{Output}= {H{Input} - H_{Kernal} + 2Padding \over Stride} + 1 $$
$$ W{Output}= {W{Input} - W_{Kernal} + 2Padding \over Stride} + 1 $$

### 卷积前向计算代码实现


卷积核，实际上和全连接层一样，是权重矩阵加偏移向量的组合，区别在于全连接层中的权重矩阵是二维的，偏移矩阵是列向量，而卷积核的权重矩阵是四维的，偏移矩阵是也是列向量。

### 卷积层的训练
(1) 计算反向传播的梯度矩阵

正向公式：
$$Z = W*A+b \tag{0}$$

其中，W是卷积核，*表示卷积（互相关）计算，A为当前层的输入项，b是偏移（未在图中画出），Z为当前层的输出项，但尚未经过激活函数处理。

### 池化的前向计算与反向传播
(1) 常用池化方法

池化 pooling，又称为下采样，downstream sampling or sub-sampling。

池化方法分为两种，一种是最大值池化 Max Pooling，一种是平均值池化 Mean/Average Pooling。

+ 最大值池化，是取当前池化视野中所有元素的最大值，输出到下一层特征图中。
+ 平均值池化，是取当前池化视野中所有元素的平均值，输出到下一层特征图中。

其目的是：
+ 扩大视野：就如同先从近处看一张图片，然后离远一些再看同一张图片，有些细节就会被忽略
+ 降维：在保留图片局部特征的前提下，使得图片更小，更易于计算
+ 平移不变性，轻微扰动不会影响输出：比如上如中最大值池化的4，即使向右偏一个像素，其输出值仍为4
+ 维持同尺寸图片，便于后端处理：假设输入的图片不是一样大小的，就需要用池化来转换成同尺寸图片
一般我们都使用最大值池化。