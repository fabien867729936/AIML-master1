# 王振宇 step6总结
## step 6 （）模型的推理与部署
已经用神经网络训练出来了一套权重矩阵如果需要将训练好的网络用到后台服务中，复用前面章节中的代码：先搭建网络，然后加载权重矩阵，最后调用前向计算。

先用前面训练好的权重矩阵搭建一个可以手工测试训练效果的应用。然后以问答的形式对模型文件进行介绍，并使用工具观察模型文件的内部结构。再然后以开放式神经网络交换（Open Neural Network Exchange，简称ONNX）格式为例，动手将前面训练好的模型保存为ONNX格式。最后以Windows平台为例，介绍如何在桌面应用中使用ONNX模型。（模型文件中不仅包含了所有的权重矩阵，还记录了该神经网络的数据流图。这样不同平台、不同语言都可以根据模型文件里的信息构建网络、加载权重矩阵、执行前向计算。）

* 手工测试训练效果
  将输入数据按一定的顺序和与权重矩阵进行运算，就可以得到对应的输出。这个过程就是推理的过程。如果没有保存这些权重矩阵，那么每次使用之前，需要重新训练，这在计算资源有限的情况下是难以接受的。
    * 训练结果的保存与加载
        它的功能就是把训练好的网络各层的权重和偏移参数保存到文件中，这样我们以后可以在使用这个网络推理时，方便地把这些参数重新加载到网络中，而不需要重新训练。前提是训练和推理的网络结构要一模一样。
    * 搭建应用
       用Python搭建一个交互式界面来实现能手写输入的程序，从而验证MNIST的训练结果。
       搭建交互式应用的实现步骤有：

        1.重现神经网络结构，加载权重和偏移数据
        2.显示界面，让用户可以用鼠标或者手指（触摸屏）写一个数字
        3.写好一个数字后，收集数据，转换数据，并触发推理过程
        4.得到推理结果
        5.清除界面，做下一次测试

    * 交互过程
      数据处理过程如下：

        1.应用程序会先把绘图区域保存为一个文件
        2.然后再把此文件读入内存，转换成灰度图
        3.缩放尺寸到28x28（和训练数据一致）
        4.用255减去所有像素值，得到黑底色白前景色的数据（和训练数据一致）
        5.归一化到[0,1]（和训练数据一致）
        6.变成1X784的数组，调用前向计算方法
        7.得到Output后，做一个argmax，取到最终结果

* 模型文件概述
  加载权重矩阵之前要先搭建网络，而且要和训练时的网络结构一致。所以，网络结构最好也可以像权重矩阵一样保存下来，在需要使用的时候进行加载。

  实际上，几乎所有的训练平台也是这么做的，会把网络结构、权重矩阵等信息保存在文件中，这就是我们常说的模型文件，后面也直接简称为模型。
  * 模型文件描述
  为了方便地重用AI模型的计算过程，我们需要将它运行的数据流图、相应的运行参数（Parameters）和训练出来的权重（Weights）保存下来，这就是AI模型文件主要描述的内容。
  * AI模型的作用
  以视觉处理为例，人通过眼睛捕获光线，传递给大脑处理，返回图像的一些信息，比如，这是花，是动物。AI模型的作用就相当于大脑的处理，能根据输入的数据给予一定的判断。
  * ONNX文件
  开放式神经网络交换（Open Neural Network Exchange，简称ONNX）是由微软、FaceBook、亚马逊等多个公司一起推出的，针对机器学习设计的开放式文件格式，可以用来存储训练好的模型。它使得不同的人工智能框架可以采用相同格式存储模型数据并交互。

  目前很多机器学习框架都支持ONNX格式，如PyTorch、Caffe2、CNTK、ML.NET、MXNet等，它们都有专门的export_to_onnx方法，通过遍历它们原生的数据流图，转化为ONNX标准的数据流图。而对于TensorFlow这样并不原生支持ONNX的框架，通常会使用图匹配（Graph Matching）的方式转化数据流图。
  * 模型文件是如何与应用程序一起工作的
  应用程序使用模型文件，本质也是要执行模型文件的数据流图。一般有两种方式实现模型文件和应用程序的协作：如果有可以独立执行模型文件的运行时（Runtime）；除此以外，我们也可以将数据流图和执行数据流图的程序（一般称为Op Kernel）编译在一起，从而脱离运行时，由于单一模型涉及到的操作有限，这样可以极大减少框架所占用的资源。

* ONNX模型文件
  ONNX的全称是开放式神经网络交换（Open Neural Network Exchange），我们已经在前面的快问快答中，对它进行了介绍。既然它是一种开放的模型文件标准格式，那么我们将尝试把前面实现的多入多出三层神经网络保存为ONNX模型文件，以方便在不同的框架中都可以使用。

  ONNX是一个开放式的规范，定义了可扩展的计算图模型、标准数据类型以及内置的运算符。该文件在存储结构上可以理解为是一种层级的结构。最顶层结构是模型（Model），模型记录了该模型文件的基本属性，如使用的ONNX标准的版本、使用的运算符集版本、制造商的名字和版本等信息，除此以外，模型中记录着最主要的信息是图（Graph）。

  * 创建ONNX节点：演示用make_node API创建一个全连接层节点。注意，由于ONNX的运算符中没有全连接运算符，所以这里用矩阵乘和矩阵加来组成一个全连接层。
  * 创建ONNX文件:根据结构，有了节点列表后，就可以创建对应的图（Graph），最终创建出模型（Model），以下就是使用onnx帮助类创建图和模型，并保存在文件中的代码。
  * 保存多入多出三层神经网络:之前的学习中训练了多入多出的三层神经网络来完成MNIST数据集的识别数字任务，现在就可以动手把训练好的网络保存为ONNX格式的模型文件。

  这个网络中的三层分别是全连接+Sigmoid、全连接+Tanh、全连接+Softmax，前面已经介绍了如何构造全连接层节点，剩下的就是激活层的构造。
* Windows中模型的部署
  微软开源了ONNX运行时库（ONNX Runtime），可以进行高性能的推理，支持主流三大操作系统平台，支持使用GPU，同时提供Python、C#、C/C++、Ruby等开发语言，能满足各种场景的使用。本小节学习了使用前面生成的mnist.onnx，创建一个Windows桌面应用，实现手写数字的识别。这里使用C#开发语言，需要安装Visual Studio开发环境。

  1. 创建WPF项目
  2. 添加模型文件到项目中
  3. 添加OnnxRuntime库
  4. 设计界面
  5. 画布数据预处理
  6. 调用模型进行推理
  7. 得到结果